#! /usr/bin/perl -w
################################################################################
# generate_SC3-DIMMSC_Rscript.pl version 1.0
# Copyright (C) Runmao Lin
# Contact (E-mail): linrunmao@caas.cn
# 
# This program is provided under the terms of a personal license to the recipient and 
# may only be used for the recipient's own research at an academic insititution.
# 
# For using this program in a company or for commercial purposes, a commercial license 
# is required.
# 
# The purpose of this program is used to generate a R script for running SC3 and DIMM-SC.
# The input file 'reformat_MG200_3_byGeneID.xls' is generated by 'reformat_matrix.pl'.
################################################################################

use strict;
use warnings;
use Getopt::Long;
use Data::Dumper;

my $reformat_byGeneID; # the file 'reformat_MG200_3_byGeneID.xls'
my $cluster; # cluster number, which is inferred from Seurat tSNE analysis
my $output; # the output R script file
my $help;
my $version=sprintf("%.1f",1.0);

GetOptions
(
	"reformat_byGeneID=s" => \$reformat_byGeneID,     # string
	"cluster=s" => \$cluster,                         # string
	"output=s" => \$output,                           # string
	"help" => \$help                                  # flag
);

################################################################################
# usage
############################# usage begin ######################################
my $usage= << "USAGE";

Example: perl $0 -reformat_byGeneID  reformat_MG200_3_byGeneID.xls  -cluster  10  -output  run_SC3-DIMMSC.R 
version: 1.0
Options:
	-reformat_byGeneID <file>       the 'reformat_MG200_3_byGeneID.xls' file for scRNA-seq data
	-output <prefix>                the output file, such as 'run_SC3-DIMMSC.R'
	-cluster <int>                  the cluster number, which is inferred from Seurat tSNE analysis
	-help                           print help information

USAGE
############################## usage end #######################################

if ($help || !(defined $reformat_byGeneID) || !(defined $output) || !(defined $cluster))
{
	print $usage;
	exit;
}

open OUT,">$output";
print OUT "library(DIMMSC)\n";
print OUT "library(SingleCellExperiment)\n";
print OUT "library(SC3)\n";
print OUT "library(scater)\n";
print OUT "\n";
print OUT "data=read.table(\"$reformat_byGeneID\", header = TRUE, sep = \"\\t\", quote = \"\", row.names = 1, as.is = TRUE)\n";
print OUT "data=as.matrix(data)\n";
print OUT "\n";
print OUT "data_cluster<-DIMMSC(data=data, K=$cluster, method_cluster_initial=\"kmeans\", method_alpha_initial=\"Ronning\", maxiter=200, tol=1e-4, lik.tol=1e-2)\n";
print OUT "\n";
print OUT "write.table(data_cluster\$mem, \"DIMMSC_K$cluster\_cell_cluster.txt\", quote=FALSE, sep=\"\\t\")\n";
print OUT "\n";
print OUT "sce <- SingleCellExperiment(assays = list(counts = data, logcounts = log2(data + 1)))\n";
print OUT "rowData(sce)\$feature_symbol <- rownames(sce)\n";
print OUT "sce.run <- sc3(sce, ks = 2\:$cluster\, biology = TRUE, n_cores = 1)\n";
print OUT "\n";
print OUT "write.table(sce.run\$sc3_$cluster\_clusters, \"SC3_K$cluster\_cell_cluster.txt\", quote=FALSE, sep=\"\\t\")\n";
close OUT;

__END__
