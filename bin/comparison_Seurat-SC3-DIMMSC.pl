#! /usr/bin/perl -w
################################################################################
# comparison_Seurat-SC3-DIMMSC.pl version 1.0
# Copyright (C) Runmao Lin
# Contact (E-mail): linrunmao@caas.cn
# 
# This program is provided under the terms of a personal license to the recipient and 
# may only be used for the recipient's own research at an academic insititution.
# 
# For using this program in a company or for commercial purposes, a commercial license 
# is required.
# 
# The purpose of this program is used to integrate cluster detection from Seurat, SC3 
# and DIMM-SC results.
# The input files of 'SC3_K4_cell_cluster.txt' and 'DIMMSC_K4_cell_cluster.txt' can be 
# obtained after running the R script generated by 'generate_SC3-DIMMSC_Rscript.pl'.
################################################################################

use strict;
use warnings;
use Getopt::Long;
use Data::Dumper;

my $cell_ID_list; # such as 'barcodes.tsv'
my $seurat_cell_list; # the cell list file, containing cell clusters generated from Seurat analysis
my $SC3_cell_cluster; # such as 'SC3_K4_cell_cluster.txt'
my $DIMMSC_cell_cluster; # such as 'DIMMSC_K4_cell_cluster.txt'
my $output; # the output file
my $help;
my $version=sprintf("%.1f",1.0);

GetOptions
(
	"cell_ID_list=s" => \$cell_ID_list,                          # string
	"seurat_cell_list=s" => \$seurat_cell_list,                  # string
	"SC3_cell_cluster=s" => \$SC3_cell_cluster,                  # string
	"DIMMSC_cell_cluster=s" => \$DIMMSC_cell_cluster,            # string
	"output=s" => \$output,                                      # string
	"help" => \$help                                             # flag
);

################################################################################
# usage
############################# usage begin ######################################
my $usage= << "USAGE";

Example: perl $0 -cell_ID_list  barcodes.tsv  -seurat_cell_list  seurat_cell.list  -SC3_cell_cluster  SC3_K4_cell_cluster.txt  -DIMMSC_cell_cluster  DIMMSC_K4_cell_cluster.txt  -output  comparison_Seurat-SC3-DIMMSC.txt 
version: 1.0
Options:
	-cell_ID_list <file>                  such as 'barcodes.tsv'
	-seurat_cell_list <file>              such as 'seurat_cell.list'
	-SC3_cell_cluster <file>              such as 'SC3_K4_cell_cluster.txt'
	-DIMMSC_cell_cluster <prefix>         such as 'DIMMSC_K4_cell_cluster.txt'
	-output <file>                        such as 'comparison_Seurat-SC3-DIMMSC.txt'
	-help                                 print help information

USAGE
############################## usage end #######################################

if ($help || !(defined $cell_ID_list) || !(defined $seurat_cell_list) || !(defined $SC3_cell_cluster) || !(defined $DIMMSC_cell_cluster) || !(defined $output))
{
	print $usage;
	exit;
}

my @months = qw(Jan Feb Mar Apr May Jun Jul Aug Sep Oct Nov Dec);
my ($timesecond, $timeminute, $timehour, $timedaymonths, $timemonth, $timeyear, $timedayweek, $timedayYear, $timedaylightsavings) = localtime();
$timeyear+=1900;

print "[$timehour\:$timeminute\:$timesecond\, $months[$timemonth] $timedaymonths\, $timeyear] ";
print "Start to run the \'$0\' program ...\n";

## 'seurat_cell.list'
# C0	/10t/linrm/single-cell/Arabidopsis_thaliana_sample3-4/200107U_S1_cellranger_v3/map_AthS4_AthS3_SeuratV4/test/cell.C0.txt

## cell.C0.txt
# # x
# # 1	AAACCCATCCAGTGTA-1

## SC3_K4_cell_cluster.txt
# # x
# # 1	2
# # 2	NA

## DIMMSC_K4_cell_cluster.txt
# # V1
# # 1	3
# # 2	2

my @cell;
open L,"$cell_ID_list" || die "Cannot open the file '$cell_ID_list'.\n";
while(<L>)
{
	chomp;
	my @sp=split(/\s+/,$_);
	if($_ ne "")
	{
		push(@cell,$sp[0]);
	}
}
close L;

my %seurat;
open SL,"$seurat_cell_list" || die "Cannot open the file '$seurat_cell_list'.\n";
while(<SL>)
{
	chomp;
	my @sp=split(/\t/,$_);
	if($_ ne "")
	{
		open C,"$sp[1]" || die "Cannot open the file '$sp[1]'.\n";
		while(<C>)
		{
			chomp;
			my @csp=split(/\t/,$_);
			if($_ ne "" && !($_=~/^x/ || $_=~/^V1/))
			{
				$seurat{$csp[1]}=$sp[0];
			}
		}
		close C;
	}
}
close SL;

my %sc3;
open SC,"$SC3_cell_cluster" || die "Cannot open the file '$SC3_cell_cluster'.\n";
while(<SC>)
{
	chomp;
	my @sp=split(/\t/,$_);
	if($_ ne "" && !($_=~/^x/ || $_=~/^V1/))
	{
		$sc3{$cell[$sp[0]-1]}=$sp[1];
	}
}
close SC;

my %dimmsc;
open D,"$DIMMSC_cell_cluster" || die "Cannot open the file '$DIMMSC_cell_cluster'.\n";
while(<D>)
{
	chomp;
	my @sp=split(/\t/,$_);
	if($_ ne "" && !($_=~/^x/ || $_=~/^V1/))
	{
		$dimmsc{$cell[$sp[0]-1]}=$sp[1];
	}
}
close D;

my %type;
open OUT,">$output";
print OUT "Cell\tSeurat\tSC3\tDIMMSC\n";
for(my $i=0;$i<@cell;$i++)
{
	if(!(defined $seurat{$cell[$i]}))
	{
		print "The cell ID '$cell[$i]' was not found in '$ARGV[1]'.\n";
		exit;
	}
	if(!(defined $sc3{$cell[$i]}))
	{
		print "The cell ID '$cell[$i]' was not found in '$ARGV[3]'.\n";
		exit;
	}
	if(!(defined $dimmsc{$cell[$i]}))
	{
		print "The cell ID '$cell[$i]' was not found in '$ARGV[4]'.\n";
		exit;
	}
	print OUT "$cell[$i]\t$seurat{$cell[$i]}\t$sc3{$cell[$i]}\t$dimmsc{$cell[$i]}\n";
	$type{"$seurat{$cell[$i]}\t$sc3{$cell[$i]}\t$dimmsc{$cell[$i]}"}++ if(!($sc3{$cell[$i]} eq "NA"));
}
close OUT;

open OB,">$output\.type.txt";
print OB "Seurat\tSC3\tDIMMSC\tCellNumber\n";
foreach my $tid(sort keys %type)
{
	print OB "$tid\t$type{$tid}\n";
}
close OB;

($timesecond, $timeminute, $timehour, $timedaymonths, $timemonth, $timeyear, $timedayweek, $timedayYear, $timedaylightsavings) = localtime();
$timeyear+=1900;
print "[$timehour\:$timeminute\:$timesecond\, $months[$timemonth] $timedaymonths\, $timeyear] ";
print "End of running the \'$0\' program.\n";

__END__
